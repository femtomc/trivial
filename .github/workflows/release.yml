name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  ZIG_VERSION: "0.15.2"

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux
            artifact: idle-linux-x86_64
            zig_platform: x86_64-linux
          - os: macos-latest
            target: x86_64-macos
            artifact: idle-macos-x86_64
            zig_platform: aarch64-macos
          - os: macos-latest
            target: aarch64-macos
            artifact: idle-macos-aarch64
            zig_platform: aarch64-macos

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        run: |
          curl -L "https://ziglang.org/download/${{ env.ZIG_VERSION }}/zig-${{ matrix.zig_platform }}-${{ env.ZIG_VERSION }}.tar.xz" | tar -xJ
          echo "$PWD/zig-${{ matrix.zig_platform }}-${{ env.ZIG_VERSION }}" >> $GITHUB_PATH

      - name: Verify Zig
        run: zig version

      - name: Build
        working-directory: cli
        run: zig build -Doptimize=ReleaseFast -Dtarget=${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          cp cli/zig-out/bin/idle dist/${{ matrix.artifact }}
          chmod +x dist/${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Prepare release assets
        run: |
          mkdir -p release
          for dir in dist/*/; do
            artifact=$(basename "$dir")
            cp "$dir$artifact" "release/$artifact"
            chmod +x "release/$artifact"
          done
          cd release
          sha256sum * > checksums.txt

      - name: Create install script
        run: |
          cat > release/install.sh << 'INSTALLER_EOF'
          #!/bin/sh
          set -e

          # idle installer - smart dependency management
          # Usage: curl -fsSL https://github.com/evil-mind-evil-sword/idle/releases/latest/download/install.sh | sh

          # Colors
          if [ -t 1 ]; then
              RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'
          else
              RED=''; GREEN=''; YELLOW=''; BLUE=''; NC=''
          fi

          info() { printf "${BLUE}info${NC}: %s\n" "$1"; }
          success() { printf "${GREEN}✓${NC} %s\n" "$1"; }
          warn() { printf "${YELLOW}warning${NC}: %s\n" "$1"; }
          error() { printf "${RED}error${NC}: %s\n" "$1" >&2; exit 1; }

          # Get latest release version from GitHub
          get_latest_version() {
              repo=$1
              curl -fsSL "https://api.github.com/repos/${repo}/releases/latest" 2>/dev/null | \
                  grep '"tag_name"' | sed -E 's/.*"v?([^"]+)".*/\1/' || echo ""
          }

          # Get installed version
          get_installed_version() {
              cmd=$1
              if command -v "$cmd" >/dev/null 2>&1; then
                  $cmd version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo ""
              else
                  echo ""
              fi
          }

          # Compare versions (returns 0 if $1 >= $2)
          version_gte() {
              [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" = "$2" ]
          }

          # Install or update a tool
          install_tool() {
              name=$1
              cmd=$2
              repo=$3
              install_cmd=$4

              installed=$(get_installed_version "$cmd")
              latest=$(get_latest_version "$repo")

              if [ -z "$latest" ]; then
                  warn "Could not fetch latest version for $name"
                  if [ -n "$installed" ]; then
                      success "$name $installed (keeping current)"
                      return
                  fi
              fi

              if [ -n "$installed" ] && [ -n "$latest" ] && version_gte "$installed" "$latest"; then
                  success "$name $installed (up to date)"
                  return
              fi

              if [ -n "$installed" ]; then
                  info "Updating $name $installed → $latest..."
              else
                  info "Installing $name..."
              fi

              eval "$install_cmd"

              new_version=$(get_installed_version "$cmd")
              if [ -n "$new_version" ]; then
                  success "$name $new_version installed"
              else
                  warn "$name installation may have failed"
              fi
          }

          # Install uv (special case - different version format)
          install_uv() {
              if command -v uv >/dev/null 2>&1; then
                  success "uv $(uv --version 2>/dev/null | head -1)"
              else
                  info "Installing uv..."
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  success "uv installed"
              fi
          }

          # Install gh (special case - uses package managers)
          install_gh() {
              if command -v gh >/dev/null 2>&1; then
                  success "gh $(gh --version 2>/dev/null | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')"
              else
                  info "Installing gh..."
                  case "$(uname -s)" in
                      Darwin*)
                          if command -v brew >/dev/null 2>&1; then
                              brew install gh
                          else
                              warn "Install Homebrew or gh manually: https://cli.github.com/"
                              return
                          fi
                          ;;
                      Linux*)
                          if command -v apt-get >/dev/null 2>&1; then
                              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                              sudo apt-get update && sudo apt-get install gh -y
                          else
                              warn "Install gh manually: https://cli.github.com/"
                              return
                          fi
                          ;;
                  esac
                  success "gh installed"
              fi
          }

          # Install idle binary to plugin cache
          install_idle_binary() {
              PLUGIN_ROOT="${HOME}/.claude/plugins/cache/emes/idle"

              if [ ! -d "$PLUGIN_ROOT" ]; then
                  info "Plugin not installed yet, skipping binary (will be installed with plugin)"
                  return
              fi

              LATEST_VERSION=$(ls -1 "$PLUGIN_ROOT" 2>/dev/null | sort -V | tail -1)
              if [ -z "$LATEST_VERSION" ]; then
                  info "No plugin version found"
                  return
              fi

              BIN_DIR="${PLUGIN_ROOT}/${LATEST_VERSION}/bin"
              mkdir -p "$BIN_DIR"

              # Check current version
              current=""
              if [ -x "${BIN_DIR}/idle" ]; then
                  current=$("${BIN_DIR}/idle" version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "")
              fi

              # Get latest version
              latest=$(get_latest_version "evil-mind-evil-sword/idle")

              if [ -n "$current" ] && [ -n "$latest" ] && version_gte "$current" "$latest"; then
                  success "idle binary $current (up to date)"
                  return
              fi

              # Determine platform
              case "$(uname -s)" in
                  Darwin*)
                      case "$(uname -m)" in
                          arm64) ARTIFACT="idle-macos-aarch64" ;;
                          x86_64) ARTIFACT="idle-macos-x86_64" ;;
                          *) warn "Unsupported architecture"; return ;;
                      esac
                      ;;
                  Linux*)
                      case "$(uname -m)" in
                          x86_64) ARTIFACT="idle-linux-x86_64" ;;
                          *) warn "Unsupported architecture"; return ;;
                      esac
                      ;;
                  *) warn "Unsupported OS"; return ;;
              esac

              if [ -n "$current" ]; then
                  info "Updating idle binary $current → $latest..."
              else
                  info "Installing idle binary..."
              fi

              URL="https://github.com/evil-mind-evil-sword/idle/releases/latest/download/${ARTIFACT}"
              if curl -fsSL "$URL" -o "${BIN_DIR}/idle"; then
                  chmod +x "${BIN_DIR}/idle"
                  success "idle binary $latest installed"
              else
                  warn "Failed to download idle binary"
              fi
          }

          # Setup Claude plugin
          setup_plugin() {
              if ! command -v claude >/dev/null 2>&1; then
                  warn "claude CLI not found, skipping plugin setup"
                  return
              fi

              # Add marketplace
              claude plugin marketplace add evil-mind-evil-sword/marketplace 2>/dev/null || true

              # Refresh to get latest versions
              info "Refreshing marketplace..."
              claude plugin marketplace refresh 2>/dev/null || true

              # Install or update plugin
              if claude plugin list 2>/dev/null | grep -q "idle@emes"; then
                  info "Updating idle plugin..."
                  claude plugin update idle@emes 2>/dev/null || {
                      claude plugin uninstall idle@emes 2>/dev/null || true
                      claude plugin install idle@emes 2>/dev/null || warn "Plugin update failed"
                  }
              else
                  info "Installing idle plugin..."
                  claude plugin install idle@emes 2>/dev/null || warn "Plugin install failed"
              fi
              success "idle plugin ready"
          }

          main() {
              printf "\n"
              printf "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
              printf "  ${BLUE}idle${NC} - installer\n"
              printf "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
              printf "\n"

              info "Checking dependencies..."
              printf "\n"

              # Core dependencies
              install_uv
              install_gh

              # emes tools (with version checking)
              install_tool "tissue" "tissue" "evil-mind-evil-sword/tissue" \
                  "curl -fsSL https://github.com/evil-mind-evil-sword/tissue/releases/latest/download/install.sh | sh"

              install_tool "jwz" "jwz" "evil-mind-evil-sword/zawinski" \
                  "curl -fsSL https://github.com/evil-mind-evil-sword/zawinski/releases/latest/download/install.sh | sh"

              install_tool "bibval" "bibval" "evil-mind-evil-sword/bibval" \
                  "curl -fsSL https://github.com/evil-mind-evil-sword/bibval/releases/latest/download/install.sh | sh"

              printf "\n"
              info "Setting up Claude Code plugin..."
              setup_plugin

              printf "\n"
              info "Installing idle binary..."
              install_idle_binary

              printf "\n"
              printf "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
              success "Installation complete!"
              printf "\n"
              printf "Get started:\n"
              printf "  ${BLUE}tissue init${NC}      # Initialize issue tracker\n"
              printf "  ${BLUE}jwz init${NC}         # Initialize messaging\n"
              printf "  ${BLUE}/init${NC}            # Plan a project with Alice\n"
              printf "  ${BLUE}/loop${NC}            # Work through issues\n"
              printf "\n"
              printf "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"
          }

          main
          INSTALLER_EOF
          chmod +x release/install.sh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
          generate_release_notes: true
